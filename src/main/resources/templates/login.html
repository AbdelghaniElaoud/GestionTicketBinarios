<!DOCTYPE html>
<html>
<head>
    <title>Login Form</title>
    <link rel="stylesheet"
          href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
</head>
<body>
<!--<form id="loginForm">-->
<!--    <input type="text" id="username" name="username" placeholder="Username">-->
<!--    <input type="password" id="password" name="password" placeholder="Password">-->
<!--    <button type="submit">Login</button>-->
<!--</form>-->

<div style="margin-top: 50px; margin-left: 35%; margin-right: 35%">
    <form id="loginForm">
        <!-- Email input -->
        <div class="form-outline mb-4">
            <input type="email" id="username" class="form-control" />
            <label class="form-label" for="username"  >Email address</label>
        </div>

        <!-- Password input -->
        <div class="form-outline mb-4">
            <input type="password" id="password" class="form-control" />
            <label class="form-label" for="password" >Password</label>
        </div>

        <!-- Submit button -->
        <button type="submit" class="btn btn-primary btn-block mb-4">Sign in</button>

    </form>
</div>

<script>
    document.getElementById("loginForm").addEventListener("submit", function(event) {
        event.preventDefault(); // Prevent form submission

        const username = document.getElementById("username").value;
        const password = document.getElementById("password").value;

        // Clear localStorage before making the authentication request
        localStorage.clear();

        const data = {
            username: username,
            password: password
        };

        fetch("http://localhost:8080/api/auth/token", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(data)
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error("Authentication failed"); // Handle non-200 responses
                }
                return response.json();
            })
            .then(result => {
                // Store the token securely (e.g., in sessionStorage)
                sessionStorage.setItem('authToken', result.token);

                // Store the JSON response under the name "authResponse"
                localStorage.setItem('authResponse', JSON.stringify(result));


                // Check if the user has the "ADMIN" or "TECH" role and redirect accordingly
                const roles = result.roles;
                if (roles.includes("ADMIN")){
                    window.location.href = 'admin';
                } else if (roles.includes("TECH")){
                    window.location.href = 'tech';
                } else if (roles.includes("CLIENT")){
                    window.location.href = 'client';
                }else{
                    console.log("Authentication failed");
                }


            })
            .catch(error => {
                // Handle authentication failure more gracefully (e.g., show an error message)
                console.error("Authentication failed:", error);
                // Display an error message on the login form
                document.getElementById("error-message").textContent = "Invalid username or password";
            });
    });
</script>

</body>
</html>
